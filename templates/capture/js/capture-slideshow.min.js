/**
 * Capture Slideshow Minified - A jQuery plugin for fullscreen slideshow functionality in the Capture WordPress theme.
 *
 * License: GPL2
 * Copyright Scott Sousa (Slocum Studio), http://slocumthemes.com/
 */

!function(e){"use strict"
function t(e){var t,s
return t={orig_height:parseInt(e.attr("height"),10),orig_width:parseInt(e.attr("width"),10),smaller_than_window:!1},t.aspect_ratio=t.orig_width/t.orig_height,t.aspect_ratio=t.aspect_ratio.toFixed(2),s={aspect_ratio:p.width()/p.height()},s.aspect_ratio=s.aspect_ratio.toFixed(2),p.width()>t.orig_width&&p.height()>t.orig_height&&(e.css({position:"absolute",top:(p.height()-e.height())/2+"px",left:(p.width()-e.width())/2+"px",width:"auto",height:"auto"}),t.smaller_than_window=!0),s.aspect_ratio!==t.aspect_ratio||t.smaller_than_window||e.css({width:p.width(),height:p.height(),top:0,left:0}),s.aspect_ratio>t.aspect_ratio&&!t.smaller_than_window&&e.css({width:"auto",height:p.height(),top:0,left:(p.width()-p.height()*t.aspect_ratio)/2+"px"}),s.aspect_ratio<t.aspect_ratio&&!t.smaller_than_window&&e.css({width:p.width(),height:p.width()/t.aspect_ratio,top:(p.height()-p.width()/t.aspect_ratio)/2+"px",left:0}),e}function s(){var t=e("body")
return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?!1:(d.capture_slideshow_elements.$parent[0].requestFullScreen?(d.capture_slideshow_elements.$parent[0].requestFullScreen(),d.capture_slideshow_elements.$parent.addClass("capture-slideshow-full capture-slideshow-fullscreen capture-slideshow-full-w3c capture-slideshow-fullscreen-w3c full-screen-w3c fullscreen-w3c")):d.capture_slideshow_elements.$parent[0].mozRequestFullScreen?(d.capture_slideshow_elements.$parent[0].mozRequestFullScreen(),d.capture_slideshow_elements.$parent.addClass("capture-slideshow-full capture-slideshow-fullscreen capture-slideshow-full-moz capture-slideshow-fullscreen-moz full-screen-moz fullscreen-moz")):d.capture_slideshow_elements.$parent[0].webkitRequestFullScreen?(d.capture_slideshow_elements.$parent[0].webkitRequestFullScreen(),d.capture_slideshow_elements.$parent.addClass("capture-slideshow-container capture-slideshow-full capture-slideshow-fullscreen capture-slideshow-full-webkit capture-slideshow-fullscreen-webkit full-screen-webkit fullscreen-webkit")):d.capture_slideshow_elements.$parent[0].msRequestFullScreen?(d.capture_slideshow_elements.$parent[0].msRequestFullScreen(),d.capture_slideshow_elements.$parent.addClass("capture-slideshow-container capture-slideshow-full capture-slideshow-fullscreen capture-slideshow-full-ms capture-slideshow-fullscreen-ms full-screen-ms fullscreen-ms")):d.capture_slideshow_elements.$parent.addClass("capture-slideshow-full capture-slideshow-fullscreen capture-slideshow-no-fullscreen-api"),t.addClass("capture-slideshow-active lightbox"),d.capture_slideshow_elements.$parent)}function l(){var t=e("body"),s=capture.permalinks?window.location.pathname:window.location.pathname+window.location.search
d.capture_slideshow_elements.$parent.data("capture-slideshow","inactive"),d.capture_slideshow_elements.$parent.off("mousemove.capture-slideshow"),d.capture_slideshow_elements.$close.off("click.capture-slideshow"),d.capture_slideshow_elements.$prev.off("click.capture-slideshow"),d.capture_slideshow_elements.$next.off("click.capture-slideshow"),e(document).off("keyup.capture-slideshow webkitfullscreenchange mozfullscreenchange fullscreenchange"),h&&"/"===s.substr(-1)||"/"===window.location.hash.substr(-1)?s=h?s.substr(0,s.length-1):window.location.hash.substr(0,window.location.hash.length-1):h||(s=window.location.hash),h&&(capture.permalinks&&"lightbox"===s.split("/").pop()||!capture.permalinks&&-1!==s.indexOf("&lightbox=true"))?r.navigate(capture.permalinks?s.replace("lightbox",""):s.replace("&lightbox=true",""),{replace:!0}):(capture.permalinks&&"#lightbox"===s||!capture.permalinks&&-1!==s.indexOf("&lightbox=true"))&&r.navigate(capture.permalinks?"/":window.location.hash.replace("&lightbox=true",""),{replace:!0}),h&&d.collection.length&&!d.collection.getModel().attributes.hasOwnProperty("initial_image")?d.capture_slideshow_elements.$ui_elements&&d.capture_slideshow_elements.$img.removeClass("loaded").fadeOut(400,function(){d.capture_slideshow_elements.$ui_elements.addClass("hidden hide initial-hide"),d.capture_slideshow_elements.$loader.removeClass("hidden hide"),r.navigate(d.collection.getModel().attributes.post.permalink,{trigger:!0}),window.location.reload(d.collection.getModel().attributes.post.permalink)}):(d.capture_slideshow_elements.$parent.attr("class","capture-slideshow-container"),t.removeClass("capture-slideshow-active lightbox")),document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()}var i,o,n,a,r,c,d,h,u,p=e(window),m=[]
e(function(){e("#capture-slideshow-template").length&&(i=Backbone.Model.extend({defaults:{img:{src:!1,width:!1,height:!1},post:{id:!1,title:!1,date:!1,permalink:!1}}}),o=Backbone.Collection.extend({model:i,url:capture.ajaxurl,initialize:function(e){this.options=e||{},_.bindAll(this,"getModel","setModel","nextModel","prevModel")},comparator:function(e){return e.get("id")},getModel:function(){return this.currentModel},setModel:function(e){this.currentModel&&this.currentModel.unset("current_image"),this.currentModel=e,this.currentModel.set({current_image:!0}),this.trigger("change",e)},nextModel:function(){return this.setModel(this.at(this.indexOf(this.getModel())+1)),this},prevModel:function(){return this.setModel(this.at(this.indexOf(this.getModel())-1)),this}}),n=new o,c=Backbone.View.extend({el:"#capture-slideshow .capture-slideshow",capture_slideshow_elements:{},model:new i,template:_.template(e("#capture-slideshow-template").html()),initialize:function(e){this.options=e||{},_.bindAll(this,"setModel","initElements","render","getImages"),this.listenTo(this.collection,"change",this.setModel),this.listenTo(this.model,"change",this.render),this.initElements()},setModel:function(e){return this.model=e,this},initElements:function(){return this.capture_slideshow_elements.$parent=this.$el.parent(),this.capture_slideshow_elements.$img=e(".capture-slideshow-photo img",this.$el),this.capture_slideshow_elements.$img_parent=this.capture_slideshow_elements.$img.parent(),this.capture_slideshow_elements.$close=e(".capture-slideshow-close",this.capture_slideshow_elements.$parent),this.capture_slideshow_elements.$prev=e(".capture-slideshow-prev",this.capture_slideshow_elements.$parent),this.capture_slideshow_elements.$next=e(".capture-slideshow-next",this.capture_slideshow_elements.$parent),this.capture_slideshow_elements.$ui_elements=e(".capture-slideshow-ui",this.capture_slideshow_elements.$parent),this.capture_slideshow_elements.$loader=e(".loader-container",this.capture_slideshow_elements.$parent),this},render:function(){if(this.collection.length){var l=this
this.$el.html(this.template(this.model.attributes)),l=this.initElements(),this.capture_slideshow_elements.$loader.removeClass("hidden hide"),this.$el.imagesLoaded().done(function(){l.capture_slideshow_elements.$parent.addClass("loaded"),l.capture_slideshow_elements.$ui_elements.removeClass("hidden hide initial-hide"),l.capture_slideshow_elements.$loader.addClass("hidden hide"),l.collection.getModel().attributes.hasOwnProperty("no_more_images")&&(0===l.collection.indexOf(l.collection.getModel())&&l.capture_slideshow_elements.$prev.addClass("disabled"),l.collection.indexOf(l.collection.getModel())===l.collection.length-1&&l.capture_slideshow_elements.$next.addClass("disabled")),l.capture_slideshow_elements.$img.fadeIn(400,function(){e(this).addClass("loaded")}),l.options.hasOwnProperty("lightbox")&&l.options.lightbox&&(l.capture_slideshow_elements.$img_parent.addClass("lightbox"),l.capture_slideshow_elements.$img.on("click.capture-slideshow",function(e){e.preventDefault(),s()})),capture.is_mobile&&"active"!==l.capture_slideshow_elements.$img.data("capture-slideshow")&&(Hammer(l.capture_slideshow_elements.$img[0]).on("dragleft swipeleft",function(){l.capture_slideshow_elements.$next.click()}),Hammer(l.capture_slideshow_elements.$img[0]).on("dragright swiperight",function(){l.capture_slideshow_elements.$prev.click()}),l.capture_slideshow_elements.$img.data("capture-slideshow","active")),t(l.capture_slideshow_elements.$img),e(window).on("resize.capture-slideshow",function(){clearTimeout(m["window-resize"]),m["window-resize"]=setTimeout(function(){t(l.capture_slideshow_elements.$img)},100)})})}return this},getImages:function(t,s){var i=this
this.collection.fetch({data:{action:"capture_slideshow",nonce:capture.nonce,current_post_id:e(".capture-slideshow-current-post-id",i.$el).val(),initial_post_id:e(".post",".content-wrapper").attr("id").replace("post-",""),num_next_prev_posts:t},success:function(e,t){_.each(e.models,function(t){t.attributes.hasOwnProperty("current_image")&&e.setModel(t)}),s(e,t)},error:function(){l(),alert("Capture Slideshow: There was an error fetching models from the server. Please try again.")}})}}),a=Backbone.Router.extend({prev_url_path:!1,routes:{"*notFound":"defaultRoute","":"defaultRoute"},defaultRoute:function(e){h&&this.prev_url_path&&e!==this.prev_url_path&&window.location.reload(),this.prev_url_path=e}}),r=new a,h=!(!window.history||!window.history.pushState),Backbone.history.start({pushState:h,root:""}),u=navigator.userAgent.match(/iPhone/i)?!0:!1)}),e.fn.captureSlideshow=function(t){var i=e(document),o=e.extend({},e.fn.captureSlideshow.defaults,t),a=capture.permalinks?window.location.pathname:window.location.pathname+window.location.search
return d instanceof Backbone.View||(d=new c({collection:n,lightbox:o.hasOwnProperty("lightbox")&&o.lightbox?!0:!1})),0===d.collection.length&&(d.capture_slideshow_elements.$ui_elements.addClass("hidden hide initial-hide"),d.getImages(2,function(){d.render()})),"/"===a.substr(-1)?a=h?a.substr(0,a.length-1):window.location.hash.substr(0,window.location.hash.length-1):h||(a=window.location.hash),h&&(capture.permalinks&&"lightbox"!==a.split("/").pop()||!capture.permalinks&&-1===a.indexOf("&lightbox=true"))?r.navigate(capture.permalinks?a+"/lightbox/":a+"&lightbox=true",{replace:!0}):(capture.permalinks&&"#lightbox"===a||!capture.permalinks&&-1===a.indexOf("&lightbox=true"))&&r.navigate(capture.permalinks?"/lightbox":"&lightbox=true",{replace:!0}),s(),"active"!==d.capture_slideshow_elements.$parent.data("capture-slideshow")&&(i.on("keyup.capture-slideshow",function(e){27===e.keyCode&&l(),37===e.keyCode&&d.capture_slideshow_elements.$prev.click(),39===e.keyCode&&d.capture_slideshow_elements.$next.click()}),i.on("webkitfullscreenchange mozfullscreenchange fullscreenchange",function(){var e=document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||!1
e||l()}),d.capture_slideshow_elements.$close.on("click.capture-slideshow",function(e){e.preventDefault(),l()}),d.capture_slideshow_elements.$prev.on("click.capture-slideshow",function(t){var s,l,i=e(this)
return t.preventDefault(),e(this).hasClass("disabled")?!1:(s=parseInt(e(this).data("capture-slideshow.clicks"),10)||0,s++,l=s>2?5:2,e(this).data("capture-slideshow.clicks",s),d.capture_slideshow_elements.$next.removeClass("disabled"),void(0!==d.collection.indexOf(d.collection.getModel())?(d.collection.prevModel(),d.capture_slideshow_elements.$img.removeClass("loaded").fadeOut(400,function(){d.render()}),d.collection.getModel().attributes.hasOwnProperty("no_more_images")&&e(this).addClass("disabled")):(d.capture_slideshow_elements.$ui_elements.addClass("hidden hide initial-hide"),d.capture_slideshow_elements.$loader.removeClass("hidden hide"),d.capture_slideshow_elements.$img.removeClass("loaded").fadeOut(400,function(){d.getImages(l,function(){0!==d.collection.indexOf(d.collection.getModel())&&(d.collection.prevModel(),d.render(),d.collection.getModel().attributes.hasOwnProperty("no_more_images")&&i.addClass("disabled"))})}))))}),d.capture_slideshow_elements.$next.on("click.capture-slideshow",function(t){var s,l,i=e(this)
return t.preventDefault(),e(this).hasClass("disabled")?!1:(s=parseInt(e(this).data("capture-slideshow.clicks"),10)||0,s++,l=s>2?5:2,e(this).data("capture-slideshow.clicks",s),d.capture_slideshow_elements.$prev.removeClass("disabled"),void(d.collection.indexOf(d.collection.getModel())!==d.collection.length-1?(d.collection.nextModel(),d.capture_slideshow_elements.$img.removeClass("loaded").fadeOut(400,function(){d.render()}),d.collection.getModel().attributes.hasOwnProperty("no_more_images")&&e(this).addClass("disabled")):(d.capture_slideshow_elements.$ui_elements.addClass("hidden hide initial-hide"),d.capture_slideshow_elements.$loader.removeClass("hidden hide"),d.capture_slideshow_elements.$img.removeClass("loaded").fadeOut(400,function(){d.getImages(l,function(){0!==d.collection.indexOf(d.collection.getModel())&&(d.collection.nextModel(),d.render(),d.collection.getModel().attributes.hasOwnProperty("no_more_images")&&i.addClass("disabled"))})}))))}),d.capture_slideshow_elements.$parent.on("mousemove.capture-slideshow",function(){return d.capture_slideshow_elements.$ui_elements?void(d.capture_slideshow_elements.$ui_elements.hasClass("initial-hide")||capture.is_mobile||(d.capture_slideshow_elements.$ui_elements.removeClass("hidden hide"),clearTimeout(m["capture-slideshow-mousemove"]),m["capture-slideshow-mousemove"]=setTimeout(function(){d.capture_slideshow_elements.$ui_elements.addClass("hidden hide")},2500))):!1}),d.capture_slideshow_elements.$parent.data("capture-slideshow","active")),this},e.fn.captureSlideshow.defaults={}}(jQuery)